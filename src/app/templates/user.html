{% extends "base.html" %}

{% block content %}
    <h1>Hello {{ user.name }}!</h1>
    <p>Track your progress and achieve your goals one step at a time.</p>

    {% if goals_with_milestones %}
        {% for item in goals_with_milestones %}
            {% set goal = item.goal %}
            {% set milestones = item.milestones %}

            <div class="card">
                <h2>{{ goal.title }}</h2>
                <p><strong>What success looks like:</strong> {{ goal.goal_outcome }}</p>
                <p><strong>Why this matters:</strong> {{ goal.goal_why }}</p>
                <p><strong>Due date:</strong> {{ goal.goal_due_date.strftime('%B %d, %Y') }}</p>
                <p><strong>Status:</strong>
                    {% if goal.is_completed %}
                        <span style="color: rgb(100, 200, 100);">✓ Completed</span>
                    {% else %}
                        <span style="color: rgb(220, 160, 60);">In Progress</span>
                    {% endif %}
                </p>

                <div style="margin-top: 1rem;">
                    <a href="{{ url_for('edit_goal', username=user.username, goal_id=goal.id) }}" class="button button-warning button-small">Edit Goal</a>
                    <form action="{{ url_for('toggle_complete_goal', username=user.username, goal_id=goal.id) }}" method="post" style="display: inline;">
                        <button type="submit" class="button {% if goal.is_completed %}button button-small{% else %}button-success button-small{% endif %}">
                            {% if goal.is_completed %}Reopen{% else %}Mark Complete{% endif %}
                        </button>
                    </form>
                    <a href="{{ url_for('create_milestone', username=user.username, goal_id=goal.id) }}" class="button button-small">Add Milestone</a>
                    <form action="{{ url_for('delete_goal', username=user.username, goal_id=goal.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this goal?');">
                        <button type="submit" class="button-danger button-small">Delete Goal</button>
                    </form>
                </div>

                {% if milestones %}
                    <button class="button button-small" onclick="toggleMilestones({{ goal.id }})" style="margin-top: 1rem;">
                        <span id="toggle-text-{{ goal.id }}">Show Milestones ({{ milestones|length }})</span>
                    </button>

                    <div id="milestones-{{ goal.id }}" style="display: none; margin-top: 1rem;">
                        <h3>Milestones</h3>
                        {% for milestone in milestones %}
                            <div class="milestone-card {% if milestone.milestone_status %}completed{% endif %}">
                                <h3 style="margin: 0; padding: 0;">{{ milestone.milestone_title }}</h3>
                                <p style="margin: 0.5rem 0;"><strong>Due:</strong> {{ milestone.milestone_due_date.strftime('%B %d, %Y') }}</p>
                                <p style="margin: 0.5rem 0;"><strong>Reward:</strong> {{ milestone.milestone_reward }}</p>
                                <p style="margin: 0.5rem 0;"><strong>Status:</strong>
                                    {% if milestone.milestone_status %}
                                        <span style="color: rgb(100, 200, 100);">✓ Completed</span>
                                    {% else %}
                                        <span style="color: rgb(220, 160, 60);">In Progress</span>
                                    {% endif %}
                                </p>
                                <div style="margin-top: 0.75rem;">
                                    <a href="{{ url_for('edit_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" class="button button-warning button-small">Edit</a>
                                    <form action="{{ url_for('toggle_complete_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" method="post" style="display: inline;">
                                        <button type="submit" class="button {% if milestone.milestone_status %}button button-small{% else %}button-success button-small{% endif %}">
                                            {% if milestone.milestone_status %}Reopen{% else %}Complete{% endif %}
                                        </button>
                                    </form>
                                    <form action="{{ url_for('delete_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this milestone?');">
                                        <button type="submit" class="button-danger button-small">Delete</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="margin-top: 1rem; color: rgba(236, 235, 234, 0.7);">No milestones yet. Break this goal into smaller steps!</p>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="card">
            <h2>No goals yet!</h2>
            <p>Ready to start achieving? Create your first goal and begin your journey.</p>
            <a href="{{ url_for('create_goal', username=user.username) }}" class="button button-success">Create Your First Goal</a>
        </div>
    {% endif %}

    <script>
        function toggleMilestones(goalId) {
            var element = document.getElementById('milestones-' + goalId);
            var toggleText = document.getElementById('toggle-text-' + goalId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
                toggleText.textContent = 'Hide Milestones';
            } else {
                element.style.display = 'none';
                var count = element.querySelectorAll('.milestone-card').length;
                toggleText.textContent = 'Show Milestones (' + count + ')';
            }
        }
    </script>
{% endblock %}