{% extends "base.html" %}

{% block content %}
    <h1>Hello {{ user.name }}, your goals are below:</h1>
    <hr>
    <h3>All your goals:</h3>
    {% for item in goals_with_milestones %}
        {% set goal = item.goal %}
        {% set milestones = item.milestones %}

        <div>
            <div>{{ goal.title }}</div>
            <div>{{ goal.goal_outcome }}</div>
            <div>Due date: {{ goal.goal_due_date }}</div>
            <div>Finished: {{ goal.is_completed }} </div>
            <br>
        </div>

        <a href="{{ url_for('edit_goal', username=user.username, goal_id=goal.id) }}" class="button">Edit</a>
        <form action="{{ url_for('toggle_complete_goal', username=user.username, goal_id=goal.id) }}" method="post" style="display: inline;">
            <button type="submit" class="button">{% if goal.is_completed %}Reopen{% else %}Complete{% endif %}</button>
        </form>
        <form action="{{ url_for('delete_goal', username=user.username, goal_id=goal.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this goal?');">
            <button type="submit" class="delete_button">Delete</button>
        </form>
        <a href="{{ url_for('create_milestone', username=user.username, goal_id=goal.id) }}" class="button">Add Milestone</a>

        <button class="button" onclick="toggleMilestones({{ goal.id }})">{% if milestones|length > 0 %}Show Milestones ({{ milestones|length }}){% else %}No Milestones{% endif %}</button>

        <div id="milestones-{{ goal.id }}" style="display: none; margin-left: 20px;">
            {% if milestones %}
                {% for milestone in milestones %}
                    <div style="border-left: 2px solid rgb(60, 60, 212); padding-left: 10px; margin: 10px 0;">
                        <div>{{ milestone.milestone_title }}</div>
                        <div>Due: {{ milestone.milestone_due_date }}</div>
                        <div>Reward: {{ milestone.milestone_reward }}</div>
                        <div>Status: {% if milestone.milestone_status %}Completed{% else %}In Progress{% endif %}</div>
                        <br>
                        <a href="{{ url_for('edit_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" class="button">Edit</a>
                        <form action="{{ url_for('toggle_complete_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" method="post" style="display: inline;">
                            <button type="submit" class="button">{% if milestone.milestone_status %}Reopen{% else %}Complete{% endif %}</button>
                        </form>
                        <form action="{{ url_for('delete_milestone', username=user.username, goal_id=goal.id, milestone_id=milestone.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this milestone?');">
                            <button type="submit" class="delete_button">Delete</button>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <p>No milestones yet. Click "Add Milestone" to create one!</p>
            {% endif %}
        </div>
        <hr>
    {% endfor %}

    <script>
        function toggleMilestones(goalId) {
            var element = document.getElementById('milestones-' + goalId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }
    </script>
{% endblock %}